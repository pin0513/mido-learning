# å®¶åº­è¨ˆåˆ†æ¿ (Family Scoreboard) â€” åŠŸèƒ½éœ€æ±‚è¦æ ¼æ›¸

**æ–‡ä»¶ç‰ˆæœ¬**ï¼šv1.0
**å»ºç«‹æ—¥æœŸ**ï¼š2026-02-18
**ç‹€æ…‹**ï¼šå¾…é–‹ç™¼äººå“¡ç¢ºèª
**è² è²¬æ¨¡çµ„**ï¼š`/experiments/family-scoreboard`ï¼ˆå‰ç«¯ç¨ç«‹æ¨¡çµ„ï¼‰

---

## 1. èƒŒæ™¯èˆ‡ç›®æ¨™

### 1.1 èƒŒæ™¯

å®¶é•·å¸Œæœ›å»ºç«‹ä¸€å¥—èƒ½è®“å­©å­èˆ‡çˆ¶æ¯**å…±åŒå”ä½œ**çš„ç©åˆ†ç³»çµ±ï¼Œé€éæ­£å‘é¼“å‹µï¼ˆè€Œéæ‡²ç½°å°å‘ï¼‰åŸ¹é¤Šè‰¯å¥½ç¿’æ…£èˆ‡å“æ ¼ã€‚æ­¤åŠŸèƒ½ä½œç‚º Mido Learning **å¯¦é©—åŠŸèƒ½**åŠ å…¥ï¼Œç¨ç«‹æ¨¡çµ„è¨­è¨ˆï¼Œä¸èˆ‡å­¸ç¿’åŠŸèƒ½æ··åˆã€‚

### 1.2 æ•™è‚²ç†è«–ä¾æ“š

| ç†è«– | æ‡‰ç”¨æ–¹å¼ |
|------|----------|
| **æ­£å¢å¼· (Positive Reinforcement)** | è¶…å‡ºæœ¬åˆ†çš„å–„è¡Œ â†’ ç«‹å³åŠ åˆ†å›é¥‹ï¼Œå¼·åŒ–å¥½è¡Œç‚º |
| **è‡ªæˆ‘æ±ºå®šç†è«– (SDT)** | å…’ç«¥å¯çœ‹åˆ°è‡ªå·±çš„æˆé•·å ±è¡¨ï¼ŒåŸ¹é¤Šè‡ªå¾‹å‹•æ©Ÿ |
| **ä»£å¹£åˆ¶åº¦ (Token Economy)** | ç©åˆ†å¯å…Œæ›çå‹µï¼Œå½¢æˆè¡Œç‚ºâ†’ç©åˆ†â†’å…Œæ›çš„æ­£å‘å¾ªç’° |
| **æˆé•·å¿ƒæ…‹ (Growth Mindset)** | é€£çºŒæˆå°± (Streak) å¼·èª¿é€²æ­¥èˆ‡å …æŒï¼Œéä¸€æ¬¡æ€§çµæœ |
| **ç¤¾æœƒå­¸ç¿’ç†è«–** | å®¶åº­æˆå“¡å¯äº’ç›¸è§€æ‘©ï¼Œå…„å¼Ÿå§Šå¦¹çš„è‰¯æ€§ç«¶çˆ­ |

### 1.3 æ ¸å¿ƒå“²å­¸

> **ã€Œåšå¥½åˆ†å…§çš„äº‹æ˜¯æ‡‰è©²çš„ï¼›è¶…è¶Šæœ¬åˆ†ï¼Œå¹«åŠ©ä»–äººï¼Œä¸æ±‚å›å ±ï¼Œæ‰å€¼å¾—çå‹µã€‚ã€**

- âŒ å®Œæˆæ—¥å¸¸è²¬ä»»ï¼ˆåƒé£¯ã€ç¡è¦ºã€ä¸Šå­¸ï¼‰= ä¸åŠ åˆ†ï¼ˆç†æ‰€ç•¶ç„¶ï¼‰
- âœ… ä¸»å‹•å¹«åŠ©å®¶äºº = åŠ åˆ†
- âœ… å°ä»–äººå‹å–„ã€ä¸æ±‚å›å ± = åŠ åˆ†
- âœ… çªç ´æˆå°±ã€é€£çºŒå …æŒ = ç‰¹æ®Šçå‹µ

---

## 2. ä½¿ç”¨è€…è§’è‰²

| è§’è‰² | æ¬Šé™ | èªªæ˜ |
|------|------|------|
| **Adminï¼ˆçˆ¶æ¯ï¼‰** | å…¨éƒ¨æ¬Šé™ | åŠ åˆ†ã€æ‰£åˆ†ã€è¨­å®šç©å®¶ã€ç®¡ç†çå‹µã€æŸ¥çœ‹å ±è¡¨ |
| **Playerï¼ˆå­©å­ï¼‰** | å”¯è®€ + å…Œæ› | æŸ¥çœ‹è‡ªå·±ç©åˆ†ã€æŸ¥çœ‹å ±è¡¨ã€ç”³è«‹å…Œæ›çå‹µ |
| **Guest** | ç„¡ | çœ‹ä¸åˆ°æ­¤åŠŸèƒ½å…¥å£ |

### 2.1 å­˜å–æ§åˆ¶

- **å¯¦é©—åŠŸèƒ½é¦–é **ï¼šæ‰€æœ‰äººå¯è¦‹å…¥å£
- **å®¶åº­è¨ˆåˆ†æ¿å…¥å£å¡ç‰‡**ï¼š**åƒ… Admin ç™»å…¥å¾Œé¡¯ç¤º**ï¼ˆå…¶ä»–äººçœ‹ä¸åˆ°æ­¤å¡ç‰‡ï¼‰
- **è¨ˆåˆ†æ¿å…§éƒ¨**ï¼šAdmin å…¨åŠŸèƒ½ï¼›Player å”¯è®€+å…Œæ›ç”³è«‹
- **ç›´æ¥ç¶²å€å­˜å–**ï¼šæœªç™»å…¥ â†’ å°å‘ç™»å…¥é 

---

## 3. åŠŸèƒ½ç¯„ç–‡ï¼ˆFeature Scopeï¼‰

### 3.1 æ ¸å¿ƒåŠŸèƒ½åˆ—è¡¨

| # | åŠŸèƒ½æ¨¡çµ„ | å„ªå…ˆç´š | èªªæ˜ |
|---|---------|--------|------|
| F1 | ç©å®¶è¨ˆåˆ†å„€è¡¨æ¿ | P0 | å¿«é€ŸåŠ æ¸›åˆ†ã€æŸ¥çœ‹ç›®å‰ç©åˆ† |
| F2 | ç©åˆ†äº¤æ˜“è¨˜éŒ„ | P0 | æ¯ç­†åŠ æ¸›åˆ†çš„æ­·å²ç´€éŒ„ |
| F3 | é›™è»Œç©åˆ†ç³»çµ± | P0 | æˆå°±åˆ†(ç´¯è¨ˆ) vs å¯å…Œæ›åˆ†(æ‰£é™¤å¾Œ) |
| F4 | çå‹µå…Œæ›ç³»çµ± | P1 | çå‹µæ¸…å–®ã€ç”³è«‹å…Œæ›ã€æ ¸å‡†æµç¨‹ |
| F5 | ç¿’æ…£è¿½è¹¤ | P1 | æ¯æ—¥ä»»å‹™ã€é€£çºŒå¤©æ•¸ Streak |
| F6 | æˆå°±ç³»çµ± | P1 | é€£çºŒé”æ¨™è§£é–æˆå°±å¾½ç«  |
| F7 | å ±è¡¨å„€è¡¨æ¿ | P1 | è¶¨å‹¢åœ–ã€æ’è¡Œæ¦œã€æˆé•·å ±å‘Š |
| F8 | ç©å®¶ç®¡ç† | P2 | æ–°å¢/ç·¨è¼¯/åœç”¨ç©å®¶è³‡æ–™ |
| F9 | ç©åˆ†é¡åˆ¥ç®¡ç† | P2 | è‡ªè¨‚åŠ åˆ†é …ç›®èˆ‡åˆ†å€¼ |

### 3.2 æœ¬æœŸç¯„ç–‡ï¼ˆMVPï¼‰

**åŒ…å«**ï¼šF1, F2, F3, F4ï¼ˆåŸºæœ¬ç‰ˆï¼‰, F7ï¼ˆç°¡ç‰ˆï¼‰, F8
**ä¸åŒ…å«ï¼ˆæœªä¾†ï¼‰**ï¼šF5 ç¿’æ…£è¿½è¹¤ã€F6 æˆå°±ç³»çµ±ã€F9 é¡åˆ¥ç®¡ç†

---

## 4. é è¨­è³‡æ–™

### 4.1 é è¨­ç©å®¶

```
ç©å®¶ 1: ç±³è±†
  - è§’è‰²ï¼šchild
  - é ­åƒï¼šğŸŒ½ï¼ˆé è¨­ï¼Œå¯æ”¹ï¼‰
  - åˆå§‹ç©åˆ†ï¼š0

ç©å®¶ 2: æ¯›è±†
  - è§’è‰²ï¼šchild
  - é ­åƒï¼šğŸ«˜ï¼ˆé è¨­ï¼Œå¯æ”¹ï¼‰
  - åˆå§‹ç©åˆ†ï¼š0
```

### 4.2 é è¨­ç©åˆ†é¡åˆ¥

| é¡åˆ¥åç¨± | åˆ†å€¼ | èªªæ˜ | åŠ /æ‰£ |
|---------|------|------|-------|
| è€ƒè©¦å„ªç§€ | +100 | è€ƒ100åˆ† | åŠ  |
| ä¸»å‹•å¹«å¿™å®¶äº‹ | +5 | è‡ªå‹•å¹«å¿™ï¼ˆä¸æ˜¯è¢«å«åˆ°ï¼‰ | åŠ  |
| å°äººå‹å–„ | +10 | å¹«åŠ©ä»–äººã€å–„å¾…ä»–äºº | åŠ  |
| è¡¨ç¾ç‰¹åˆ¥å„ªç§€ | +20 | ç‰¹æ®Šæ­£å‘è¡Œç‚º | åŠ  |
| å…„å¼Ÿåµæ¶ | -20 | é›™æ–¹åŒæ™‚æ‰£ï¼ˆå¯è¨­å®šï¼‰ | æ‰£ |
| ä¸èª å¯¦ | -30 | èªªè¬Šã€æ¬ºé¨™ | æ‰£ |
| è‡ªè¨‚åŠ åˆ† | è‡ªè¨‚ | è‡ªç”±è¼¸å…¥åŸå› èˆ‡åˆ†å€¼ | åŠ  |
| è‡ªè¨‚æ‰£åˆ† | è‡ªè¨‚ | è‡ªç”±è¼¸å…¥åŸå› èˆ‡åˆ†å€¼ | æ‰£ |

### 4.3 é è¨­çå‹µæ¸…å–®

| çå‹µåç¨± | æ‰€éœ€ç©åˆ† | èªªæ˜ |
|---------|---------|------|
| çœ‹ä¸€é›†å¡é€š | 50 | é¡å¤–çœ‹é›»è¦–æ™‚é–“ |
| é¸æ“‡ä»Šæ™šæ™šé¤ | 100 | è‡ªå·±æ±ºå®šåƒä»€éº¼ |
| è²·ä¸€å€‹å°ç©å…· | 500 | 100å…ƒä»¥ä¸‹ç©å…· |
| å‡ºéŠä¸€æ¬¡ | 1000 | é¸æ“‡é€±æœ«å»å“ªç© |

---

## 5. è©³ç´°åŠŸèƒ½è¦æ ¼

### 5.1 F1 â€” ç©å®¶è¨ˆåˆ†å„€è¡¨æ¿ï¼ˆä¸»é é¢ï¼‰

**æ‰‹æ©Ÿæ“ä½œå„ªå…ˆï¼ˆMobile-Firstï¼‰**

**é¡¯ç¤ºå…§å®¹**ï¼š
- æ‰€æœ‰ç©å®¶çš„å¡ç‰‡ï¼ˆä¸¦æ’ï¼Œå¯æ°´å¹³æ»‘å‹•ï¼‰
- æ¯å¼µå¡ç‰‡é¡¯ç¤ºï¼š
  - ç©å®¶åå­— + é ­åƒ
  - ğŸ“Š æˆå°±åˆ†ï¼ˆç´¯è¨ˆç¸½å¾—åˆ†ï¼Œåªå¢ä¸æ¸›ï¼‰
  - ğŸ å¯å…Œæ›åˆ†ï¼ˆå¯ç”¨æ–¼å…Œæ›çå‹µçš„é¤˜é¡ï¼‰
  - æœ€è¿‘ä¸€ç­†äº¤æ˜“æ‘˜è¦

**Admin æ“ä½œ**ï¼š
- é»æ“Šä»»ä¸€ç©å®¶å¡ç‰‡ â†’ å±•é–‹åŠ æ¸›åˆ†å¿«é€Ÿæ“ä½œé¢æ¿
- å¿«é€ŸåŠ åˆ†æŒ‰éˆ•ï¼šé è¨­é¡åˆ¥ï¼ˆä¸€éµå¥—ç”¨ï¼‰
- è‡ªè¨‚è¼¸å…¥ï¼šè¼¸å…¥åˆ†å€¼ + åŸå› æ–‡å­—
- ç¢ºèªå‰é¡¯ç¤ºï¼šã€Œçµ¦ [ç©å®¶åå­—] [+/-åˆ†] å› ç‚º [åŸå› ]ã€
- æ”¯æ´**åŒæ™‚å°å¤šä½ç©å®¶æ“ä½œ**ï¼ˆå¦‚å…„å¼Ÿåµæ¶åŒæ™‚æ‰£åˆ†ï¼‰

**äº’å‹•æµç¨‹**ï¼š
```
Admin é»æ“Šç©å®¶å¡ç‰‡
  â†’ å±•é–‹åº•éƒ¨æŠ½å±œ (Bottom Sheet)
  â†’ é¸æ“‡é¡åˆ¥ æˆ– è‡ªè¨‚
  â†’ è¼¸å…¥å‚™è¨»ï¼ˆå¯é¸ï¼‰
  â†’ é»æ“Šç¢ºèª
  â†’ ç©åˆ†ç«‹å³æ›´æ–° + å‹•ç•«æ•ˆæœ
  â†’ è‡ªå‹•é—œé–‰æŠ½å±œ
```

### 5.2 F3 â€” é›™è»Œç©åˆ†è¨­è¨ˆï¼ˆæ ¸å¿ƒè¨­è¨ˆï¼‰

> å…Œçå¾Œï¼Œç¸¾åˆ†è·Ÿèƒ½è®Šçå‹µçš„åˆ†æ•¸æ‡‰è©²åˆ†è»Œè¨ˆç®—

| ç©åˆ†è»Œé“ | èªªæ˜ | è®Šå‹•è¦å‰‡ |
|---------|------|---------|
| **æˆå°±åˆ† (Achievement Points)** | ç´¯è¨ˆç¸½å¾—åˆ†ï¼Œåªå¢ä¸æ¸›ï¼Œé¡¯ç¤ºäººç”Ÿæˆå°± | è³ºåˆ°å°±åŠ ï¼Œæ°¸ä¸æ‰£é™¤ï¼ˆæ‰£åˆ†äº‹ä»¶ä¸å½±éŸ¿æ­¤æ•¸å­—çš„ã€Œç¸½è³ºå–é‡ã€ï¼‰|
| **å¯å…Œæ›åˆ† (Redeemable Points)** | ç›®å‰å¯ç”¨é¤˜é¡ï¼Œå…Œæ›å¾Œæ‰£é™¤ | è³ºåˆ°åŠ ï¼Œè¢«æ‡²ç½°æ‰£ï¼Œå…Œæ›æ™‚æ‰£ |

**èˆ‰ä¾‹èªªæ˜**ï¼š
```
åˆå§‹ç‹€æ…‹ï¼šæˆå°±åˆ† 0ï¼Œå¯å…Œæ›åˆ† 0

+100ï¼ˆè€ƒè©¦å„ªç§€ï¼‰  â†’ æˆå°±åˆ† 100ï¼Œå¯å…Œæ›åˆ† 100
+5ï¼ˆå¹«å¿™å®¶äº‹ï¼‰    â†’ æˆå°±åˆ† 105ï¼Œå¯å…Œæ›åˆ† 105
-20ï¼ˆå…„å¼Ÿåµæ¶ï¼‰   â†’ æˆå°±åˆ† 105ï¼Œå¯å…Œæ›åˆ† 85  â† æˆå°±åˆ†ä¸è®Šï¼
å…Œæ›çå‹µ -50      â†’ æˆå°±åˆ† 105ï¼Œå¯å…Œæ›åˆ† 35  â† æˆå°±åˆ†ä¸è®Šï¼
```

**è¨­è¨ˆæ„åœ–**ï¼šæˆå°±åˆ†ä»£è¡¨å­©å­çš„ã€Œäººç”Ÿæˆå°±ç´¯ç©ã€ï¼Œçµ•ä¸å› æ‡²ç½°æˆ–å…Œæ›è€Œæ¸›å°‘ï¼Œä¿è­·å­©å­çš„æˆå°±æ„Ÿèˆ‡è‡ªä¿¡å¿ƒã€‚

### 5.3 F4 â€” çå‹µå…Œæ›ç³»çµ±

**æµç¨‹**ï¼š
```
ç©å®¶æŸ¥çœ‹çå‹µæ¸…å–®
  â†’ é»æ“Šæƒ³å…Œæ›çš„çå‹µ
  â†’ ç³»çµ±ç¢ºèªã€Œå¯å…Œæ›åˆ†ã€æ˜¯å¦è¶³å¤ 
  â†’ è¶³å¤ ï¼šæäº¤å…Œæ›ç”³è«‹ï¼ˆç‹€æ…‹ï¼špendingï¼‰
  â†’ Admin æ”¶åˆ°é€šçŸ¥
  â†’ Admin æ ¸å‡† â†’ æ‰£é™¤å¯å…Œæ›åˆ† â†’ å…Œæ›è¨˜éŒ„å®Œæˆ
  â†’ Admin æ‹’çµ• â†’ åˆ†æ•¸ä¸æ‰£ â†’ é€šçŸ¥ç©å®¶
```

**å…Œæ›ç”³è«‹ç‹€æ…‹**ï¼š`pending` â†’ `approved` / `rejected`

### 5.4 F5 â€” ç¿’æ…£è¿½è¹¤ï¼ˆç¬¬äºŒæœŸï¼‰

> æ—¥å¸¸ç¿’æ…£è¿½è¹¤ï¼Œè¦æœ‰é€£çºŒå¤©æ•¸ Streakï¼Œé¤Šæˆç¿’æ…£æ‰ç®—å€¼å¾—è¨ˆåˆ†

**è¦å‰‡è¨­è¨ˆ**ï¼š
- ç¿’æ…£ä»»å‹™è¨­å®šï¼ˆå¦‚ï¼šæ¯å¤©ç·´ç´30åˆ†é˜ï¼‰
- æ¯æ—¥æ‰“å¡ç¢ºèªå®Œæˆ
- Streak è¨ˆç®—ï¼šé€£çºŒå¤©æ•¸ä¸ä¸­æ–·
- ç©åˆ†è¦å‰‡ï¼š
  - å®Œæˆç•¶æ—¥ä»»å‹™ï¼š+åŸºç¤åˆ†ï¼ˆå¦‚+2ï¼‰
  - é€£çºŒ3å¤©ï¼š+é¡å¤–çå‹µåˆ†ï¼ˆå¦‚+10ï¼‰
  - é€£çºŒ7å¤©ï¼šæˆå°±å¾½ç«  + å¤§é‡çå‹µåˆ†
  - é€£çºŒ30å¤©ï¼šè¶…ç´šæˆå°± + ç‰¹æ®Šçå‹µ
- ä¸­æ–· Streakï¼šä¸æ‰£åˆ†ï¼Œä½† Streak æ­¸é›¶é‡ä¾†

**æ³¨æ„**ï¼šæ­¤åŠŸèƒ½**èˆ‡éŠæˆ²æˆå°±ç³»çµ±è„«å‹¾**ï¼Œç¨ç«‹é‹ä½œã€‚

### 5.5 F7 â€” å ±è¡¨å„€è¡¨æ¿

**å ±è¡¨é¡å‹**ï¼š

1. **ç©åˆ†è¶¨å‹¢åœ–**ï¼ˆæŠ˜ç·šåœ–ï¼‰
   - æ™‚é–“è»¸ï¼šéå»7å¤© / 30å¤© / 90å¤©
   - é¡¯ç¤ºå¯å…Œæ›åˆ†çš„è®ŠåŒ–æ›²ç·š
   - å„ç©å®¶ä¸åŒé¡è‰²

2. **è¡Œç‚ºåˆ†é¡åœ“é¤…åœ–**
   - æœ¬æœˆåŠ åˆ†ä¾†æºæ¯”ä¾‹ï¼ˆå“ªé¡è¡Œç‚ºè³ºæœ€å¤šåˆ†ï¼‰
   - æœ‰åŠ©å®¶é•·äº†è§£å­©å­è¡Œç‚ºæ¨¡å¼

3. **æˆå°±ç¸½è¦½**
   - æˆå°±åˆ†æ’è¡Œï¼ˆå®¶åº­æ’è¡Œæ¦œï¼Œæ­£å‘æ¯”è¼ƒï¼Œä¸æ˜¯ç«¶çˆ­ï¼‰
   - æœ€è¿‘ç²å¾—çš„æˆå°±å¾½ç« 

4. **æœˆåº¦æˆé•·å ±å‘Š**
   - æœ¬æœˆç¸½å¾—åˆ† / ç¸½æ‰£åˆ†
   - æœ€å¸¸è¦‹çš„åŠ åˆ†è¡Œç‚º
   - Streak æœ€é«˜è¨˜éŒ„

---

## 6. Firebase NoSQL è³‡æ–™è¨­è¨ˆ

### 6.1 Collection æ¶æ§‹

```
families/
  {familyId}/                          # å®¶åº­æ ¹ç¯€é»
    config/
      settings: {                      # å®¶åº­è¨­å®š
        name: string,
        createdAt: Timestamp,
        adminUids: string[]            # å¯ä»¥æ“ä½œçš„ Firebase UID
      }

    players/
      {playerId}: {                    # ç©å®¶è³‡æ–™
        name: string,                  # "ç±³è±†"
        avatar: string,                # emoji æˆ– url
        role: "child" | "parent",
        color: string,                 # å€‹äººä¸»é¡Œè‰²
        isActive: boolean,
        createdAt: Timestamp
      }

    scores/
      {playerId}: {                    # å³æ™‚ç©åˆ†ï¼ˆå¿«é€Ÿè®€å–ï¼‰
        achievementPoints: number,    # æˆå°±åˆ†ï¼ˆåªå¢ä¸æ¸›ï¼‰
        redeemablePoints: number,     # å¯å…Œæ›åˆ†ï¼ˆå¯æ‰£ï¼‰
        totalEarned: number,          # ç¸½è³ºå–ï¼ˆçµ±è¨ˆç”¨ï¼‰
        totalDeducted: number,        # ç¸½æ‰£åˆ†ï¼ˆçµ±è¨ˆç”¨ï¼‰
        totalRedeemed: number,        # ç¸½å…Œæ›ï¼ˆçµ±è¨ˆç”¨ï¼‰
        lastUpdated: Timestamp
      }

    transactions/
      {txId}: {                       # æ¯ç­†ç©åˆ†äº¤æ˜“
        playerId: string,             # å—å½±éŸ¿ç©å®¶
        playerIds: string[],          # æ”¯æ´å¤šç©å®¶ï¼ˆå¦‚å…„å¼ŸåŒæ™‚æ‰£åˆ†ï¼‰
        type: "earn" | "deduct",
        amount: number,               # çµ•å°å€¼ï¼ˆæ­£æ•¸ï¼‰
        reason: string,               # åŸå› æ–‡å­—
        categoryId: string | null,    # é¡åˆ¥ IDï¼ˆå¯ç©ºï¼‰
        createdBy: string,            # admin UID
        createdAt: Timestamp,
        note: string | null           # é¡å¤–å‚™è¨»
      }

    categories/
      {catId}: {                      # ç©åˆ†é¡åˆ¥
        name: string,
        defaultAmount: number,        # é è¨­åˆ†å€¼ï¼ˆæ­£æ•¸ï¼‰
        type: "earn" | "deduct",
        icon: string,                 # emoji
        isActive: boolean,
        order: number                 # é¡¯ç¤ºé †åº
      }

    rewards/
      {rewardId}: {                   # çå‹µæ¸…å–®
        name: string,
        cost: number,                 # æ‰€éœ€å¯å…Œæ›åˆ†
        description: string,
        icon: string,
        isActive: boolean,
        stock: number | null          # null = ç„¡é™
      }

    redemptions/
      {redemptionId}: {               # å…Œæ›ç”³è«‹
        playerId: string,
        rewardId: string,
        rewardName: string,           # å¿«ç…§ï¼ˆé˜²æ­¢çå‹µè¢«ä¿®æ”¹å¾Œå¤±çœŸï¼‰
        cost: number,                 # å¿«ç…§
        status: "pending" | "approved" | "rejected",
        requestedAt: Timestamp,
        processedAt: Timestamp | null,
        processedBy: string | null,   # admin UID
        note: string | null
      }

    habits/                          # ç¬¬äºŒæœŸ
      {habitId}: {
        name: string,
        description: string,
        basePoints: number,           # æ¯æ—¥å®ŒæˆåŸºç¤åˆ†
        streakBonus: {               # Streak çå‹µè¨­å®š
          days: number,
          bonusPoints: number
        }[],
        targetPlayerIds: string[],    # é©ç”¨å“ªäº›ç©å®¶
        isActive: boolean
      }

    habitLogs/                       # ç¬¬äºŒæœŸ
      {logId}: {
        habitId: string,
        playerId: string,
        date: string,                 # "YYYY-MM-DD"
        completed: boolean,
        currentStreak: number,        # æ‰“å¡æ™‚çš„é€£çºŒå¤©æ•¸
        pointsEarned: number
      }
```

### 6.2 Firestore Security Rulesï¼ˆè‰ç¨¿ï¼‰

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /families/{familyId}/{document=**} {
      // Admin å¯è®€å¯«å…¨éƒ¨
      allow read, write: if isAdmin(familyId);
      // Player å”¯è®€ï¼ˆå…Œæ›ç”³è«‹ä¾‹å¤–ï¼‰
      allow read: if isFamilyMember(familyId);
      // å…Œæ›ç”³è«‹ï¼šPlayer å¯è‡ªè¡Œå»ºç«‹
      match /redemptions/{redemptionId} {
        allow create: if isFamilyMember(familyId)
                      && request.resource.data.status == "pending";
      }
    }

    function isAdmin(familyId) {
      return request.auth != null &&
             request.auth.uid in get(/databases/$(database)/documents/
               families/$(familyId)/config/settings).data.adminUids;
    }

    function isFamilyMember(familyId) {
      return request.auth != null;  // æš«å®šï¼šå·²ç™»å…¥å³å¯
    }
  }
}
```

### 6.3 è³‡æ–™è®€å–ç­–ç•¥

| æ“ä½œ | Collection | ç­–ç•¥ |
|------|-----------|------|
| é¡¯ç¤ºç›®å‰ç©åˆ† | `scores/{playerId}` | å³æ™‚ç›£è½ (onSnapshot) |
| åŠ æ¸›åˆ† | Transaction: scores + transactions | Atomic write |
| äº¤æ˜“è¨˜éŒ„ | `transactions` | åˆ†é  + æœ€æ–°20ç­† |
| å…Œæ›ç”³è«‹ | `redemptions` | ç›£è½ pending æ•¸é‡ |
| å ±è¡¨è³‡æ–™ | `transactions` | æ™‚é–“ç¯„åœ query |

---

## 7. UI/UX è¨­è¨ˆè¦æ ¼

### 7.1 é é¢çµæ§‹

```
/experiments/family-scoreboard            # ä¸»é ï¼ˆå„€è¡¨æ¿ï¼‰
  /experiments/family-scoreboard/player/[id]  # ç©å®¶è©³ç´°è¨˜éŒ„
  /experiments/family-scoreboard/rewards       # çå‹µå…Œæ›ä¸­å¿ƒ
  /experiments/family-scoreboard/reports      # å ±è¡¨å„€è¡¨æ¿
  /experiments/family-scoreboard/admin        # Admin ç®¡ç†è¨­å®š
    /admin/players                           # ç©å®¶ç®¡ç†
    /admin/categories                        # ç©åˆ†é¡åˆ¥ç®¡ç†
    /admin/rewards-manage                    # çå‹µç®¡ç†
```

### 7.2 æ‰‹æ©Ÿå„ªå…ˆè¨­è¨ˆè¦æ ¼

- **åº•éƒ¨å°èˆªåˆ—**ï¼ˆTab Barï¼‰ï¼šğŸ é¦–é  | ğŸ“‹è¨˜éŒ„ | ğŸå…Œæ› | ğŸ“Šå ±è¡¨
- **åŠ æ¸›åˆ†æ“ä½œ**ï¼šBottom Sheetï¼ˆå¾ä¸‹æ–¹æ»‘å‡ºï¼‰ï¼Œæ‹‡æŒ‡å¯è¼•é¬†æ“ä½œ
- **ç©å®¶å¡ç‰‡**ï¼šå¤§åœ“è§’ã€å¤§å­—é«”ï¼Œæ‰‹æŒ‡è§¸ç¢°é¢ç© â‰¥ 44px
- **ç¢ºèªæŒ‰éˆ•**ï¼šåº•éƒ¨å›ºå®šï¼Œæ–¹ä¾¿æ‹‡æŒ‡é»æ“Š
- **æ•¸å­—è¼¸å…¥**ï¼šå„ªå…ˆè§¸ç™¼æ•¸å­—éµç›¤ (`inputMode="numeric"`)
- **å‹•ç•«**ï¼šç©åˆ†æ›´æ–°æ™‚æœ‰å½ˆè·³å‹•ç•«ï¼ˆæ­£é¢åé¥‹ï¼‰

### 7.3 è¦–è¦ºé¢¨æ ¼

- **è‰²èª¿**ï¼šæº«æš–ã€æœ‰æ´»åŠ›ï¼ˆå€åˆ¥æ–¼ Mido Learning çš„å­¸è¡“é¢¨æ ¼ï¼‰
- **ä¸»è‰²**ï¼šæ©™è‰²/ç¥ç€è‰²ç³»ï¼ˆä»£è¡¨æ´»åŠ›èˆ‡æˆå°±ï¼‰
- **ç©å®¶é¡è‰²**ï¼šç±³è±† = é‡‘é»ƒè‰² ğŸŒ½ï¼Œæ¯›è±† = ç¶ è‰² ğŸ«˜
- **æˆå°±å¾½ç« **ï¼šåœ“å½¢ï¼Œæœ‰å…‰æšˆæ•ˆæœ
- **å­—é«”**ï¼šåœ“é«”æ„Ÿï¼Œå‹å–„è¦ªåˆ‡

---

## 8. å¾Œç«¯æ¶æ§‹è¦æ ¼ï¼ˆ.NET éš”é›¢å±¤ï¼‰

### 8.0 å¾Œç«¯æ¶æ§‹æ±ºç­–

**æœ¬åŠŸèƒ½æ¡ç”¨ .NET API ä½œç‚º Firebase éš”é›¢å±¤ï¼Œèˆ‡ç¾æœ‰ mido-learning å¾Œç«¯æ¶æ§‹ä¸€è‡´ã€‚**

```
Browser (Next.js)
    â”‚
    â”‚  REST APIï¼ˆJWT Authï¼‰
    â–¼
.NET APIï¼ˆASP.NET Coreï¼‰
    â”‚
    â”‚  Firebase Admin SDKï¼ˆServer-sideï¼‰
    â–¼
Firebase Firestore
```

| å±¤æ¬¡ | æŠ€è¡“é¸æ“‡ | ç†ç”± |
|------|---------|------|
| **å‰ç«¯** | Next.jsï¼ˆç´” REST å‘¼å«ï¼‰ | ä¸ä½¿ç”¨ Firebase client SDKï¼Œé™ä½å‰ç«¯è¤‡é›œåº¦ |
| **API å±¤** | ASP.NET Core Controller | èˆ‡ç¾æœ‰ mido-learning å¾Œç«¯ä¸€è‡´ï¼Œçµ±ä¸€ JWT é©—è­‰ |
| **Firebase å­˜å–** | Firebase Admin SDKï¼ˆserver-sideï¼‰ | Service Account ä¸æš´éœ²åˆ° clientï¼Œå®‰å…¨æ€§æ›´é«˜ |
| **åŸå­æ€§æ“ä½œ** | Firebase Admin SDK Transactions | server-side åŸ·è¡Œï¼Œå¼·åˆ¶ admin æ¬Šé™ä¿è­· |
| **è³‡æ–™åº«** | Firebase Firestore | ä¿ç•™ç¾æœ‰ Schema è¨­è¨ˆ |
| **Security Rules** | ç°¡åŒ–ï¼ˆå¾Œç«¯è² è²¬æˆæ¬Šï¼‰ | .NET å±¤å·²é©—è­‰æ¬Šé™ï¼ŒRules åªé˜²ç›´æ¥å­˜å– |

**èˆ‡åŸ Firebase-Only æ–¹æ¡ˆçš„å·®ç•°**ï¼š

| é¢å‘ | Firebase-Onlyï¼ˆèˆŠï¼‰ | .NET éš”é›¢å±¤ï¼ˆæ–°ï¼‰ |
|------|------------------|-----------------|
| æ¶æ§‹ä¸€è‡´æ€§ | âŒ å‰ç«¯ç›´é€£ Firebase | âœ… èˆ‡æ—¢æœ‰ mido-learning ä¸€è‡´ |
| Secret å®‰å…¨ | âš ï¸ client config å¤–éœ² | âœ… Service Account åœ¨ server |
| å‰ç«¯è¤‡é›œåº¦ | é«˜ï¼ˆéœ€ Firebase SDKï¼‰ | ä½ï¼ˆåªéœ€å‘¼å« RESTï¼‰ |
| æœªä¾†å¯é·ç§»æ€§ | å·®ï¼ˆå‰ç«¯è€¦åˆ Firebaseï¼‰ | å¥½ï¼ˆåªæ”¹ .NET service å±¤ï¼‰ |

---

### 8.1 API ç«¯é»å®šç¾©

æ‰€æœ‰ç«¯é»éœ€ JWT é©—è­‰ï¼ˆ`[Authorize]`ï¼‰ï¼Œç”±ç¾æœ‰ mido-learning èªè­‰ä¸­ä»‹å±¤è™•ç†ã€‚

| Method | Endpoint | èªªæ˜ | æ¬Šé™ |
|--------|----------|------|------|
| `GET` | `/api/family-scoreboard/scores` | å–å¾—æ‰€æœ‰ç©å®¶ç©åˆ† | å·²ç™»å…¥ |
| `GET` | `/api/family-scoreboard/transactions` | å–å¾—äº¤æ˜“è¨˜éŒ„ï¼ˆåˆ†é ï¼‰ | å·²ç™»å…¥ |
| `POST` | `/api/family-scoreboard/transactions` | æ–°å¢ç©åˆ†ï¼æ‰£åˆ† | Admin |
| `GET` | `/api/family-scoreboard/rewards` | å–å¾—çå‹µåˆ—è¡¨ | å·²ç™»å…¥ |
| `POST` | `/api/family-scoreboard/redemptions` | ç”³è«‹å…Œæ›çå‹µ | Player |
| `PATCH` | `/api/family-scoreboard/redemptions/{id}` | æ ¸å‡†ï¼æ‹’çµ•å…Œæ› | Admin |
| `GET` | `/api/family-scoreboard/redemptions` | å–å¾—å…Œæ›ç”³è«‹åˆ—è¡¨ | å·²ç™»å…¥ |
| `POST` | `/api/family-scoreboard/initialize` | åˆå§‹åŒ–å®¶åº­è³‡æ–™ | Admin |

**Request / Response ç¯„ä¾‹**ï¼š

```
POST /api/family-scoreboard/transactions
{
  "playerIds": ["player_mido"],
  "type": "earn",
  "amount": 10,
  "reason": "ä¸»å‹•å¹«å¿™æ´—ç¢—",
  "categoryId": "cat_2"
}

â†’ 204 No Content

---

PATCH /api/family-scoreboard/redemptions/{id}
{
  "action": "approve"   // æˆ– "reject"
}

â†’ 204 No Content
```

---

### 8.2 .NET Controllerï¼ˆC#ï¼‰

```csharp
// Controllers/FamilyScoreboardController.cs
[ApiController]
[Route("api/family-scoreboard")]
[Authorize]
public class FamilyScoreboardController : ControllerBase
{
    private readonly IFamilyScoreboardService _service;

    public FamilyScoreboardController(IFamilyScoreboardService service)
        => _service = service;

    // GET /api/family-scoreboard/scores
    [HttpGet("scores")]
    public async Task<IActionResult> GetScores(CancellationToken ct)
    {
        var familyId = GetFamilyId();
        var scores = await _service.GetScoresAsync(familyId, ct);
        return Ok(scores);
    }

    // GET /api/family-scoreboard/transactions?playerId=&limit=20
    [HttpGet("transactions")]
    public async Task<IActionResult> GetTransactions(
        [FromQuery] string? playerId,
        [FromQuery] int limit = 20,
        CancellationToken ct = default)
    {
        var familyId = GetFamilyId();
        var transactions = await _service.GetTransactionsAsync(familyId, playerId, limit, ct);
        return Ok(transactions);
    }

    // POST /api/family-scoreboard/transactions  [Admin Only]
    [HttpPost("transactions")]
    [Authorize(Policy = "FamilyAdmin")]
    public async Task<IActionResult> AddTransaction(
        [FromBody] AddTransactionRequest request,
        CancellationToken ct)
    {
        var familyId = GetFamilyId();
        var adminUid = GetCurrentUid();
        await _service.AddTransactionAsync(familyId, request with { CreatedBy = adminUid }, ct);
        return NoContent();
    }

    // GET /api/family-scoreboard/rewards
    [HttpGet("rewards")]
    public async Task<IActionResult> GetRewards(CancellationToken ct)
    {
        var familyId = GetFamilyId();
        var rewards = await _service.GetRewardsAsync(familyId, ct);
        return Ok(rewards);
    }

    // POST /api/family-scoreboard/redemptions  [Player]
    [HttpPost("redemptions")]
    public async Task<IActionResult> CreateRedemption(
        [FromBody] CreateRedemptionRequest request,
        CancellationToken ct)
    {
        var familyId = GetFamilyId();
        var playerId = GetCurrentUid();
        await _service.CreateRedemptionAsync(familyId, playerId, request, ct);
        return NoContent();
    }

    // PATCH /api/family-scoreboard/redemptions/{id}  [Admin Only]
    [HttpPatch("redemptions/{redemptionId}")]
    [Authorize(Policy = "FamilyAdmin")]
    public async Task<IActionResult> ProcessRedemption(
        string redemptionId,
        [FromBody] ProcessRedemptionRequest request,
        CancellationToken ct)
    {
        var familyId = GetFamilyId();
        var adminUid = GetCurrentUid();
        await _service.ProcessRedemptionAsync(familyId, redemptionId, adminUid, request.Action, ct);
        return NoContent();
    }

    // GET /api/family-scoreboard/redemptions
    [HttpGet("redemptions")]
    public async Task<IActionResult> GetRedemptions(
        [FromQuery] string? status,
        CancellationToken ct = default)
    {
        var familyId = GetFamilyId();
        var redemptions = await _service.GetRedemptionsAsync(familyId, status, ct);
        return Ok(redemptions);
    }

    // POST /api/family-scoreboard/initialize  [Admin Only]
    [HttpPost("initialize")]
    [Authorize(Policy = "FamilyAdmin")]
    public async Task<IActionResult> Initialize(CancellationToken ct)
    {
        var adminUid = GetCurrentUid();
        var familyId = await _service.InitializeFamilyAsync(adminUid, ct);
        return Ok(new { familyId });
    }

    private string GetFamilyId() => $"family_{GetCurrentUid()}";
    private string GetCurrentUid() => User.FindFirstValue(ClaimTypes.NameIdentifier)
        ?? throw new UnauthorizedAccessException();
}
```

---

### 8.3 Service ä»‹é¢ï¼ˆ`IFamilyScoreboardService`ï¼‰

```csharp
// Services/Music/IFamilyScoreboardService.cs
using MidoLearning.Api.Models.FamilyScoreboard;

namespace MidoLearning.Api.Services.FamilyScoreboard;

public interface IFamilyScoreboardService
{
    // â”€â”€ ç©åˆ†æŸ¥è©¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Task<IReadOnlyList<PlayerScoreDto>> GetScoresAsync(
        string familyId, CancellationToken ct = default);

    Task<IReadOnlyList<TransactionDto>> GetTransactionsAsync(
        string familyId, string? playerId = null, CancellationToken ct = default);

    // â”€â”€ ç©åˆ†ç•°å‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// <summary>æ–°å¢åŠ åˆ†æˆ–æ‰£åˆ†ç´€éŒ„ï¼Œä¸¦åŸå­æ›´æ–° scores æ–‡ä»¶</summary>
    Task<TransactionDto> AddTransactionAsync(
        string familyId, AddTransactionRequest request, string adminUid,
        CancellationToken ct = default);

    // â”€â”€ çå‹µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Task<IReadOnlyList<RewardDto>> GetRewardsAsync(
        string familyId, CancellationToken ct = default);

    // â”€â”€ å…Œæ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Task<RedemptionDto> CreateRedemptionAsync(
        string familyId, CreateRedemptionRequest request, string playerUid,
        CancellationToken ct = default);

    Task<RedemptionDto> ProcessRedemptionAsync(
        string familyId, string redemptionId, ProcessRedemptionRequest request,
        string adminUid, CancellationToken ct = default);

    Task<IReadOnlyList<RedemptionDto>> GetRedemptionsAsync(
        string familyId, string? status = null, CancellationToken ct = default);

    // â”€â”€ å®¶åº­åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// <summary>é¦–æ¬¡ä½¿ç”¨æ™‚å»ºç«‹é è¨­ç©å®¶ã€é¡åˆ¥ã€çå‹µï¼›å·²å­˜åœ¨å‰‡ç›´æ¥è¿”å›</summary>
    Task InitializeAsync(string familyId, string adminUid, CancellationToken ct = default);
}
```

---

### 8.4 Firebase Admin Service å¯¦ä½œï¼ˆ`FirebaseScoreboardService`ï¼‰

é—œéµæ–¹æ³•ç¯„ä¾‹ï¼ˆå®Œæ•´é¡åˆ¥ç”± dotnet-expert å¯¦ä½œï¼‰ï¼š

```csharp
// Services/FamilyScoreboard/FirebaseScoreboardService.cs
using Google.Cloud.Firestore;
using MidoLearning.Api.Models.FamilyScoreboard;

namespace MidoLearning.Api.Services.FamilyScoreboard;

public class FirebaseScoreboardService : IFamilyScoreboardService
{
    private readonly FirestoreDb _db;
    private readonly ILogger<FirebaseScoreboardService> _logger;

    public FirebaseScoreboardService(FirestoreDb db,
        ILogger<FirebaseScoreboardService> logger)
    {
        _db = db;
        _logger = logger;
    }

    // â”€â”€ åˆå§‹åŒ–ï¼ˆBatch Writeï¼Œå†ªç­‰ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    public async Task InitializeAsync(string familyId, string adminUid,
        CancellationToken ct = default)
    {
        var settingsRef = _db
            .Collection("families").Document(familyId)
            .Collection("config").Document("settings");

        var snap = await settingsRef.GetSnapshotAsync(ct);
        if (snap.Exists) return; // å·²åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›

        var batch = _db.StartBatch();

        // å®¶åº­è¨­å®š
        batch.Set(settingsRef, new
        {
            name = "æˆ‘çš„å®¶åº­è¨ˆåˆ†æ¿",
            createdAt = Timestamp.GetCurrentTimestamp(),
            adminUids = new[] { adminUid }
        });

        // é è¨­ç©å®¶ï¼ˆç±³è±† + æ¯›è±†ï¼‰
        AddDefaultPlayer(batch, familyId, "player_mido",  "ç±³è±†", "#F59E0B");
        AddDefaultPlayer(batch, familyId, "player_maodo", "æ¯›è±†", "#10B981");

        // é è¨­é¡åˆ¥ï¼ˆ5 ç­†ï¼‰
        var categories = new[]
        {
            ("è€ƒè©¦å„ªç§€",     100, "earn",   1),
            ("ä¸»å‹•å¹«å¿™å®¶äº‹",   5, "earn",   2),
            ("å°äººå‹å–„",      10, "earn",   3),
            ("å…„å¼Ÿåµæ¶",      20, "deduct", 4),
            ("ä¸èª å¯¦",        30, "deduct", 5),
        };
        foreach (var (name, amount, type, order) in categories)
        {
            var catRef = _db.Collection("families").Document(familyId)
                .Collection("categories").Document($"cat_{order}");
            batch.Set(catRef, new
            {
                name, defaultAmount = amount, type,
                isActive = true, order
            });
        }

        // é è¨­çå‹µï¼ˆ4 ç­†ï¼‰
        var rewards = new[]
        {
            ("çœ‹ä¸€é›†å¡é€š",   50,   "é¡å¤–çœ‹é›»è¦–æ™‚é–“",   "reward_1"),
            ("é¸æ“‡ä»Šæ™šæ™šé¤", 100,  "è‡ªå·±æ±ºå®šåƒä»€éº¼",   "reward_2"),
            ("è²·ä¸€å€‹å°ç©å…·", 500,  "100å…ƒä»¥ä¸‹ç©å…·",    "reward_3"),
            ("å‡ºéŠä¸€æ¬¡",     1000, "é¸æ“‡é€±æœ«å»å“ªç©",   "reward_4"),
        };
        foreach (var (rName, cost, desc, rId) in rewards)
        {
            var rRef = _db.Collection("families").Document(familyId)
                .Collection("rewards").Document(rId);
            batch.Set(rRef, new { name = rName, cost, description = desc, isActive = true });
        }

        await batch.CommitAsync(ct);
    }

    // â”€â”€ æ–°å¢ç•°å‹•ï¼ˆFirestore Transactionï¼Œä¿æŒ scores åŸå­æ›´æ–°ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    public async Task<TransactionDto> AddTransactionAsync(
        string familyId, AddTransactionRequest req, string adminUid,
        CancellationToken ct = default)
    {
        var txId = Guid.NewGuid().ToString("N");
        var txRef = _db.Collection("families").Document(familyId)
            .Collection("transactions").Document(txId);

        await _db.RunTransactionAsync(async transaction =>
        {
            foreach (var playerId in req.PlayerIds)
            {
                var scoreRef = _db.Collection("families").Document(familyId)
                    .Collection("scores").Document(playerId);

                var scoreSnap = await transaction.GetSnapshotAsync(scoreRef, ct);
                var current = scoreSnap.Exists
                    ? scoreSnap.ConvertTo<PlayerScoreDoc>()
                    : new PlayerScoreDoc();

                int delta = req.Type == "earn" ? req.Amount : -req.Amount;
                transaction.Update(scoreRef, new Dictionary<string, object>
                {
                    ["achievementPoints"] =
                        req.Type == "earn"
                            ? current.AchievementPoints + req.Amount
                            : current.AchievementPoints,
                    ["redeemablePoints"] =
                        Math.Max(0, current.RedeemablePoints + delta),
                    ["totalEarned"] =
                        req.Type == "earn"
                            ? current.TotalEarned + req.Amount
                            : current.TotalEarned,
                    ["totalDeducted"] =
                        req.Type == "deduct"
                            ? current.TotalDeducted + req.Amount
                            : current.TotalDeducted,
                    ["lastUpdated"] = Timestamp.GetCurrentTimestamp(),
                });
            }

            transaction.Set(txRef, new
            {
                playerIds    = req.PlayerIds,
                type         = req.Type,
                amount       = req.Amount,
                reason       = req.Reason,
                categoryId   = req.CategoryId,
                createdBy    = adminUid,
                createdAt    = Timestamp.GetCurrentTimestamp(),
                note         = req.Note,
            });
        }, cancellationToken: ct);

        // ... è¿”å› DTO
        return new TransactionDto { Id = txId, /* ... */ };
    }

    // â”€â”€ ç§æœ‰è¼”åŠ©ï¼šæ–°å¢é è¨­ç©å®¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    private void AddDefaultPlayer(WriteBatch batch, string familyId,
        string playerId, string name, string color)
    {
        var playerRef = _db.Collection("families").Document(familyId)
            .Collection("players").Document(playerId);
        batch.Set(playerRef, new
        {
            name, color, role = "child", isActive = true,
            createdAt = Timestamp.GetCurrentTimestamp()
        });

        var scoreRef = _db.Collection("families").Document(familyId)
            .Collection("scores").Document(playerId);
        batch.Set(scoreRef, new
        {
            achievementPoints = 0, redeemablePoints = 0,
            totalEarned = 0, totalDeducted = 0, totalRedeemed = 0,
            lastUpdated = Timestamp.GetCurrentTimestamp()
        });
    }
}
```

---

### 8.5 C# DTO Records èˆ‡ DI æ³¨å†Š

#### Request / Response DTOsï¼ˆ`Models/FamilyScoreboard/`ï¼‰

```csharp
// Models/FamilyScoreboard/Dtos.cs
namespace MidoLearning.Api.Models.FamilyScoreboard;

// â”€â”€ Response DTOs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

public record PlayerScoreDto(
    string PlayerId,
    string Name,
    string Color,
    int AchievementPoints,
    int RedeemablePoints,
    int TotalEarned,
    int TotalDeducted,
    int TotalRedeemed
);

public record TransactionDto(
    string Id,
    IReadOnlyList<string> PlayerIds,
    string Type,        // "earn" | "deduct"
    int Amount,
    string Reason,
    string? CategoryId,
    string CreatedBy,
    DateTimeOffset CreatedAt,
    string? Note
);

public record RewardDto(
    string Id,
    string Name,
    int Cost,
    string Description,
    string Icon,
    bool IsActive,
    int? Stock
);

public record RedemptionDto(
    string Id,
    string PlayerId,
    string RewardId,
    string RewardName,
    int Cost,
    string Status,      // "pending" | "approved" | "rejected"
    DateTimeOffset RequestedAt,
    DateTimeOffset? ProcessedAt,
    string? ProcessedBy,
    string? Note
);

// â”€â”€ Request DTOs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

public record AddTransactionRequest(
    IReadOnlyList<string> PlayerIds,
    string Type,         // "earn" | "deduct"
    int Amount,
    string Reason,
    string? CategoryId,
    string? Note
);

public record CreateRedemptionRequest(
    string RewardId,
    string? Note
);

public record ProcessRedemptionRequest(
    string Action,       // "approve" | "reject"
    string? Note
);
```

#### Firestore å…§éƒ¨æ–‡ä»¶å°æ‡‰ï¼ˆ`PlayerScoreDoc`ï¼‰

```csharp
// Models/FamilyScoreboard/PlayerScoreDoc.cs
using Google.Cloud.Firestore;

namespace MidoLearning.Api.Models.FamilyScoreboard;

[FirestoreData]
public class PlayerScoreDoc
{
    [FirestoreProperty("achievementPoints")] public int AchievementPoints { get; set; }
    [FirestoreProperty("redeemablePoints")]  public int RedeemablePoints  { get; set; }
    [FirestoreProperty("totalEarned")]       public int TotalEarned       { get; set; }
    [FirestoreProperty("totalDeducted")]     public int TotalDeducted     { get; set; }
    [FirestoreProperty("totalRedeemed")]     public int TotalRedeemed     { get; set; }
}
```

#### DI æ³¨å†Šï¼ˆ`Program.cs` æ–°å¢ç‰‡æ®µï¼‰

```csharp
// Program.cs â€” åœ¨ç¾æœ‰ Firebase Admin SDK æ³¨å†Šä¹‹å¾ŒåŠ å…¥

// Firebase Admin SDKï¼ˆè‹¥æœªæ³¨å†Šï¼‰
var firebaseApp = FirebaseApp.DefaultInstance
    ?? FirebaseApp.Create(new AppOptions
    {
        Credential = GoogleCredential.GetApplicationDefault()
    });

// Firestore
builder.Services.AddSingleton(_ =>
    FirestoreDb.Create(builder.Configuration["Firebase:ProjectId"]
        ?? throw new InvalidOperationException("Firebase:ProjectId not set")));

// Family Scoreboard Service
builder.Services.AddScoped<IFamilyScoreboardService, FirebaseScoreboardService>();
```

#### `appsettings.json` æ–°å¢è¨­å®š

```json
{
  "Firebase": {
    "ProjectId": "mido-learning"
  }
}
```

> **Cloud Run éƒ¨ç½²**ï¼šService Account æ¬Šé™é€é `GOOGLE_APPLICATION_CREDENTIALS` ç’°å¢ƒè®Šæ•¸æˆ– Workload Identity å‚³å…¥ï¼Œä¸éœ€è¦åœ¨ç¨‹å¼ç¢¼ä¸­æŒ‡å®šé‡‘é‘°æª”æ¡ˆè·¯å¾‘ã€‚

---

## 9. æŠ€è¡“æ¶æ§‹è¦æ ¼ï¼ˆå‰ç«¯ï¼‰

### 8.1 æ¨¡çµ„ç¨ç«‹åŸå‰‡

```
frontend/
  app/
    (public)/
      experiments/
        family-scoreboard/           # ä¸»è·¯ç”±æ¨¡çµ„ï¼ˆç¨ç«‹ï¼‰
          page.tsx                   # ä¸»å„€è¡¨æ¿
          layout.tsx                 # æ¨¡çµ„ Layoutï¼ˆå«åº•éƒ¨å°èˆªï¼‰
          player/[id]/page.tsx
          rewards/page.tsx
          reports/page.tsx
          admin/
            page.tsx
            players/page.tsx

  lib/
    family-scoreboard/               # ç¨ç«‹æœå‹™å±¤
      firestore.ts                   # Firestore CRUDï¼ˆåªæ­¤æ¨¡çµ„ç”¨ï¼‰
      types.ts                       # TypeScript å‹åˆ¥å®šç¾©
      constants.ts                   # é è¨­è³‡æ–™ï¼ˆç©å®¶ã€é¡åˆ¥ã€çå‹µï¼‰
      utils.ts                       # ç©åˆ†è¨ˆç®—ã€æ ¼å¼åŒ–

  components/
    family-scoreboard/               # ç¨ç«‹ UI å…ƒä»¶
      PlayerCard.tsx
      ScoreTransactionSheet.tsx      # Bottom Sheet
      RewardCard.tsx
      HabitTracker.tsx               # ç¬¬äºŒæœŸ
      charts/
        PointsTrendChart.tsx
        CategoryPieChart.tsx
```

**å…±ç”¨ï¼ˆå¯å¾ Mido Learning å¼•ç”¨ï¼‰**ï¼š
- `lib/firebase.ts` â€” Firebase åˆå§‹åŒ–ï¼ˆå…±ç”¨ï¼‰
- `components/ui/Button.tsx` â€” åŸºç¤æŒ‰éˆ•
- `hooks/useAuth.ts` â€” Auth hook
- `components/auth/AuthProvider.tsx`

### 8.2 ç‹€æ…‹ç®¡ç†

- ä½¿ç”¨ **React Context** ç®¡ç† `familyId`ï¼ˆä¸å¼•å…¥ Zustandï¼Œä¿æŒæ¨¡çµ„ç¨ç«‹ï¼‰
- ç©åˆ†å³æ™‚æ›´æ–°ï¼š**Firestore onSnapshot**
- è¡¨å–®ç‹€æ…‹ï¼š`useState`ï¼ˆä¸éœ€è¦å…¨åŸŸï¼‰

### 8.3 åˆå§‹åŒ–é‚è¼¯

```typescript
// ç¬¬ä¸€æ¬¡é€²å…¥æ™‚ï¼Œè‡ªå‹•åˆå§‹åŒ–é è¨­è³‡æ–™
async function initializeFamilyIfNeeded(uid: string): Promise<string> {
  // 1. æŸ¥è©¢ uid æ˜¯å¦å·²æœ‰ family
  // 2. æ²’æœ‰ â†’ å»ºç«‹æ–° family + é è¨­ç©å®¶ + é è¨­é¡åˆ¥ + é è¨­çå‹µ
  // 3. æœ‰ â†’ ç›´æ¥è¿”å› familyId
}
```

---

## 9. é©—æ”¶æ¢ä»¶ï¼ˆAcceptance Criteriaï¼‰

### AC1ï¼šAdmin å­˜å–æ§åˆ¶
- Given Admin å·²ç™»å…¥
- When é€²å…¥ `/experiments` é é¢
- Then çœ‹åˆ°ã€Œå®¶åº­è¨ˆåˆ†æ¿ã€å¡ç‰‡
- And é Admin ç”¨æˆ¶çœ‹ä¸åˆ°æ­¤å¡ç‰‡

### AC2ï¼šé è¨­ç©å®¶åˆå§‹åŒ–
- Given Admin é¦–æ¬¡é€²å…¥å®¶åº­è¨ˆåˆ†æ¿
- When ç³»çµ±è‡ªå‹•åˆå§‹åŒ–
- Then é¡¯ç¤ºã€Œç±³è±†ã€å’Œã€Œæ¯›è±†ã€å…©ä½ç©å®¶ï¼Œå„è‡ªç©åˆ†ç‚º 0

### AC3ï¼šåŠ åˆ†æ“ä½œ
- Given Admin åœ¨ä¸»å„€è¡¨æ¿
- When é»æ“Šç©å®¶å¡ç‰‡ â†’ é¸æ“‡ã€Œä¸»å‹•å¹«å¿™å®¶äº‹ã€(+5)
- Then è©²ç©å®¶çš„ã€Œå¯å…Œæ›åˆ†ã€+5ï¼Œã€Œæˆå°±åˆ†ã€+5
- And äº¤æ˜“è¨˜éŒ„ä¸­å‡ºç¾æ­¤ç­†è¨˜éŒ„

### AC4ï¼šé›™è»Œç©åˆ†
- Given ç©å®¶æœ‰æˆå°±åˆ† 100ï¼Œå¯å…Œæ›åˆ† 100
- When Admin æ‰£åˆ† -20ï¼ˆå…„å¼Ÿåµæ¶ï¼‰
- Then æˆå°±åˆ†ç¶­æŒ 100ï¼Œå¯å…Œæ›åˆ†è®Šç‚º 80

### AC5ï¼šå…Œæ›ä¸å½±éŸ¿æˆå°±åˆ†
- Given ç©å®¶æœ‰æˆå°±åˆ† 100ï¼Œå¯å…Œæ›åˆ† 80
- When ç©å®¶ç”³è«‹å…Œæ›ã€Œçœ‹ä¸€é›†å¡é€šã€(-50)ï¼ŒAdmin æ ¸å‡†
- Then æˆå°±åˆ†ç¶­æŒ 100ï¼Œå¯å…Œæ›åˆ†è®Šç‚º 30

### AC6ï¼šæ‰‹æ©Ÿæ“ä½œæµæš¢
- Given åœ¨ 375px å¯¬åº¦æ‰‹æ©Ÿä¸Š
- When åŸ·è¡ŒåŠ åˆ†æ“ä½œ
- Then Bottom Sheet å¾åº•éƒ¨æ»‘å‡ºï¼ŒæŒ‰éˆ•å¯ç”¨æ‹‡æŒ‡è§¸åŠ
- And æ“ä½œä¸è¶…é 3 æ­¥å®Œæˆ

### AC7ï¼šå ±è¡¨å¯è®€
- Given Admin æˆ– Player é€²å…¥å ±è¡¨é 
- When é¸æ“‡ã€Œéå»30å¤©ã€
- Then é¡¯ç¤ºç©åˆ†è¶¨å‹¢æŠ˜ç·šåœ–ï¼Œå„ç©å®¶ç”¨ä¸åŒé¡è‰²å€åˆ†

---

## 10. éåŠŸèƒ½éœ€æ±‚

| é …ç›® | è¦æ ¼ |
|------|------|
| **æ•ˆèƒ½** | ç©åˆ†æ›´æ–°åœ¨ 500ms å…§åæ˜ åˆ°ç•«é¢ |
| **é›¢ç·š** | åŸºæœ¬æŸ¥çœ‹åŠŸèƒ½åœ¨ç„¡ç¶²è·¯æ™‚é¡¯ç¤ºå¿«å–è³‡æ–™ |
| **å®‰å…¨æ€§** | Firestore Security Rules é˜²æ­¢è·¨å®¶åº­å­˜å– |
| **å¯æ“´å……æ€§** | å®¶åº­æˆå“¡å¯æ“´å……ï¼ˆä¸é™ 2 äººï¼‰ï¼Œæœªä¾†æ”¯æ´å¤šå€‹å®¶åº­ |
| **è³‡æ–™ä¿è­·** | å…’ç«¥è³‡æ–™ä¸å°å¤–å…¬é–‹ï¼Œåƒ…å®¶åº­æˆå“¡å¯è®€ |

---

## 11. é–‹ç™¼é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å…§å®¹ | ä¼°è¨ˆ |
|--------|------|------|
| M1 | Firebase è³‡æ–™è¨­è¨ˆ + åˆå§‹åŒ–é‚è¼¯ + åŸºç¤å‹åˆ¥ | 0.5 å¤© |
| M2 | ä¸»å„€è¡¨æ¿ + ç©å®¶å¡ç‰‡ + åŠ æ¸›åˆ† Bottom Sheet | 1 å¤© |
| M3 | é›™è»Œç©åˆ†é‚è¼¯ + äº¤æ˜“è¨˜éŒ„é  | 0.5 å¤© |
| M4 | çå‹µæ¸…å–® + å…Œæ›ç”³è«‹ + Admin æ ¸å‡† | 1 å¤© |
| M5 | å ±è¡¨å„€è¡¨æ¿ï¼ˆè¶¨å‹¢åœ– + åœ“é¤…åœ–ï¼‰| 0.5 å¤© |
| M6 | Admin ç®¡ç†é  + ç©å®¶ç®¡ç† | 0.5 å¤© |
| M7 | æ•´åˆæ¸¬è©¦ + æ‰‹æ©Ÿ UX èª¿æ•´ | 0.5 å¤© |
| **åˆè¨ˆ** | | **4.5 å¤©** |

**ç¬¬äºŒæœŸï¼ˆç¿’æ…£è¿½è¹¤ + æˆå°±ç³»çµ±ï¼‰**ï¼šå¦è¡Œè¦åŠƒ

---

## 12. é–‹æ”¾å•é¡Œï¼ˆå¾…ç¢ºèªï¼‰

| # | å•é¡Œ | é è¨­ç­”æ¡ˆ | éœ€ç¢ºèª |
|---|------|---------|--------|
| Q1 | familyId æ€éº¼èˆ‡ Firebase Auth UID é—œè¯ï¼Ÿ | Admin UID = family çš„å”¯ä¸€è­˜åˆ¥åŸºç¤ | âœ… å¯ç¢ºèª |
| Q2 | å°å­©(Player)æ˜¯å¦éœ€è¦ç¨ç«‹ Firebase å¸³è™Ÿï¼Ÿ | ç›®å‰ Admin ä»£ç‚ºæ“ä½œï¼ŒPlayer ä¸éœ€ç™»å…¥ | å¾…ç¢ºèª |
| Q3 | ç©åˆ†æ˜¯å¦æœ‰ä¸Šé™æˆ–ä¸‹é™ï¼ˆå¦‚æœ€ä½ä¸èƒ½ä½æ–¼0ï¼‰ï¼Ÿ | å¯å…Œæ›åˆ†æœ€ä½ç‚º 0ï¼ˆä¸èƒ½ç‚ºè² ï¼‰| å¾…ç¢ºèª |
| Q4 | å…Œæ›ç”³è«‹å¯ä»¥è¢«ç©å®¶å–æ¶ˆå—ï¼Ÿ| å¯ä»¥ï¼ˆåœ¨ pending ç‹€æ…‹ä¸‹ï¼‰| å¾…ç¢ºèª |
| Q5 | ç¿’æ…£è¿½è¹¤æ˜¯å¦è¦åœ¨ MVP ä¸€èµ·åšï¼Ÿ | ç¬¬äºŒæœŸå†åš | å¾…ç¢ºèª |

---

**è¦æ ¼æ›¸ç‰ˆæœ¬æ­·å²**

| ç‰ˆæœ¬ | æ—¥æœŸ | èªªæ˜ |
|------|------|------|
| v1.0 | 2026-02-18 | åˆç‰ˆï¼Œæ•´åˆç”¨æˆ¶æ‰€æœ‰éœ€æ±‚èªªæ˜ |
