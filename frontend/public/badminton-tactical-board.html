<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ç¾½çƒæˆ°è¡“ç‰ˆ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:#1a1a2e;touch-action:none;}

/* â”€â”€ Portrait è­¦å‘Š â”€â”€ */
#portrait-warning{
  display:none;position:fixed;inset:0;z-index:9999;
  background:#1a1a2e;flex-direction:column;
  align-items:center;justify-content:center;gap:16px;text-align:center;color:#eee;
}
@media(orientation:portrait){#portrait-warning{display:flex;}}
#portrait-warning .icon{font-size:3.5rem;animation:spin 2s ease-in-out infinite;}
@keyframes spin{0%,100%{transform:rotate(0deg);}50%{transform:rotate(90deg);}}

/* â”€â”€ App â”€â”€ */
#app{display:flex;flex-direction:column;height:100vh;width:100vw;}

/* â”€â”€ Toolbar â”€â”€ */
#toolbar{
  display:flex;align-items:center;gap:5px;flex-wrap:nowrap;
  padding:4px 8px;background:#16213e;
  border-bottom:1px solid #0f3460;flex-shrink:0;overflow-x:auto;
}
#toolbar::-webkit-scrollbar{height:3px;}
#toolbar::-webkit-scrollbar-thumb{background:#0f3460;border-radius:2px;}

/* â”€â”€ ä¸»å…§å®¹ â”€â”€ */
#main{display:flex;flex:1;overflow:hidden;min-height:0;}

/* â”€â”€ å ´åœ°å®¹å™¨ â”€â”€ */
#court-container{
  flex:1;display:flex;align-items:center;justify-content:center;
  padding:6px;overflow:hidden;position:relative;
}
#court-wrapper{position:relative;}
canvas{display:block;}
#draw-canvas{position:absolute;top:0;left:0;cursor:crosshair;}

/* â”€â”€ é€šç”¨æŒ‰éˆ• â”€â”€ */
.btn{
  padding:4px 8px;border-radius:6px;border:1px solid #0f3460;
  background:#0f3460;color:#ddd;cursor:pointer;font-size:11px;
  text-align:center;user-select:none;touch-action:manipulation;
  white-space:nowrap;transition:background .12s;
}
.btn:hover,.btn:active{background:#1a5276;}
.btn.on{background:#2471a3;border-color:#3498db;color:#fff;}
.btn.red{background:#7b241c;border-color:#e74c3c;}
.btn.red:hover,.btn.red:active{background:#c0392b;}

.mode-row{display:flex;gap:3px;}
.mode-row .btn{flex:1;padding:4px 3px;}

.lbl{font-size:9px;color:#777;text-transform:uppercase;letter-spacing:.4px;}
.sep-v{width:1px;height:20px;background:#333;flex-shrink:0;}

/* â”€â”€ å ´åœ°å´é‚Šæ¨™ç±¤ â”€â”€ */
#side-labels{
  position:absolute;top:0;left:0;width:100%;height:100%;
  display:flex;pointer-events:none;
}
.side-lbl{flex:1;display:flex;align-items:flex-start;justify-content:center;padding-top:3px;font-size:9px;font-weight:bold;opacity:.8;}

/* â”€â”€ ç™¼çƒæ¨™èªŒ â”€â”€ */
#serve-flag{
  position:absolute;font-size:18px;pointer-events:none;
  filter:drop-shadow(0 0 3px gold);display:none;
}

/* â•â•â• æµ®å‹• HUD â•â•â• */
#hud{
  position:absolute;bottom:10px;left:10px;z-index:20;
  display:flex;flex-direction:column;gap:5px;
  user-select:none;
}

/* çƒå“¡åˆ— / çƒåˆ—å…±ç”¨ */
#hud-players, #hud-balls{display:flex;gap:5px;}

.hud-entity{
  width:40px;height:40px;border-radius:50%;
  border:2.5px solid rgba(255,255,255,0.25);
  background:var(--c);cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-weight:bold;color:#fff;font-size:11px;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
  transition:border-color .12s, transform .1s;
  touch-action:manipulation;
  backdrop-filter:blur(4px);
  position:relative;overflow:hidden;
}
.hud-entity:hover{transform:scale(1.08);}
.hud-entity.sel{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,0.5),0 2px 8px rgba(0,0,0,0.5);}
.hud-entity.pending{border-color:#facc15;box-shadow:0 0 0 3px rgba(250,204,21,0.6),0 2px 8px rgba(0,0,0,0.5);animation:pulse-place .8s ease-in-out infinite;}
@keyframes pulse-place{0%,100%{box-shadow:0 0 0 3px rgba(250,204,21,0.6),0 2px 8px rgba(0,0,0,0.5);}50%{box-shadow:0 0 0 6px rgba(250,204,21,0.3),0 2px 8px rgba(0,0,0,0.5);}}
.hud-entity .eid{font-size:13px;font-weight:800;line-height:1;}
.hud-entity .eini{font-size:8px;opacity:.8;line-height:1;}
/* çƒçš„åœ“å½¢ç¨å°ï¼Œæ–¹ä¾¿å€åˆ† */
.hud-ball{width:34px;height:34px;border-radius:50%;}

/* æ“ä½œåˆ— */
#hud-actions{display:flex;gap:5px;}

.hud-btn{
  height:32px;border-radius:8px;
  border:1px solid rgba(255,255,255,0.15);
  background:rgba(15,20,40,0.72);
  color:#ddd;cursor:pointer;font-size:11px;
  padding:0 9px;
  display:flex;align-items:center;gap:3px;
  box-shadow:0 2px 6px rgba(0,0,0,0.4);
  backdrop-filter:blur(8px);
  touch-action:manipulation;
  transition:background .12s;
  white-space:nowrap;
}
.hud-btn:hover,.hud-btn:active{background:rgba(36,113,163,0.72);}
.hud-btn.red{border-color:rgba(231,76,60,.35);}
.hud-btn.red:hover,.hud-btn.red:active{background:rgba(192,57,43,0.7);}

/* HUD åˆ†éš”æ¨™ç±¤ */
.hud-sep{font-size:8px;color:#556;text-transform:uppercase;letter-spacing:.4px;align-self:center;}
</style>
</head>
<body>

<!-- è±å±è­¦å‘Š -->
<div id="portrait-warning">
  <div class="icon">ğŸ“±</div>
  <h2 style="font-size:1.2rem">è«‹å°‡è£ç½®æ—‹è½‰ç‚ºæ©«å‘</h2>
  <p style="color:#888;font-size:12px">Rotate to landscape to use the tactical board</p>
</div>

<div id="app">

  <!-- å·¥å…·åˆ— -->
  <div id="toolbar">
    <span class="lbl">æ¨¡å¼</span>
    <div class="mode-row">
      <button class="btn on" id="btn-draw"  onclick="setMode('draw')"  title="èµ°ç·š [Q]">âœï¸èµ°ç·š</button>
      <button class="btn"    id="btn-place" onclick="setMode('place')" title="ç«™ä½ [W]">ğŸ‘¤ç«™ä½</button>
      <button class="btn"    id="btn-erase" onclick="setMode('erase')" title="æ“¦é™¤ [E]">ğŸ§¹æ“¦é™¤</button>
    </div>

    <div class="sep-v"></div>
    <span class="lbl">å ´å‹</span>
    <button class="btn on" id="btn-doubles" onclick="setCourtType('doubles')">é›™æ‰“</button>
    <button class="btn"    id="btn-singles" onclick="setCourtType('singles')">å–®æ‰“</button>

    <div class="sep-v"></div>
    <span class="lbl">ç·šæ¢</span>
    <div class="mode-row">
      <button class="btn on" id="btn-solid"  onclick="setDash('solid')">å¯¦ç·š</button>
      <button class="btn"    id="btn-dashed" onclick="setDash('dashed')">è™›ç·š</button>
      <button class="btn"    id="btn-arrow"  onclick="setDash('arrow')">ç®­é ­</button>
    </div>
    <input type="range" id="lw" min="1" max="8" value="3"
           style="width:60px;accent-color:#3498db;"
           oninput="state.lineWidth=+this.value" title="ç·šæ¢ç²—ç´°">

    <div class="sep-v"></div>
    <span class="lbl">ç™¼çƒ</span>
    <button class="btn" id="btn-sl" onclick="setServe('left')"  title="å·¦ç™¼çƒ [A]">â—€å·¦</button>
    <button class="btn" id="btn-sr" onclick="setServe('right')" title="å³ç™¼çƒ [D]">å³â–¶</button>
    <button class="btn" id="btn-sn" onclick="setServe('none')"  title="æ¸…é™¤">âœ•</button>

    <div class="sep-v"></div>
    <span class="lbl">æˆ‘æ–¹åœ¨</span>
    <button class="btn on" id="btn-hl" onclick="setHome('left')">å·¦</button>
    <button class="btn"    id="btn-hr" onclick="setHome('right')">å³</button>
  </div>

  <!-- ä¸»å€åŸŸ -->
  <div id="main">
    <div id="court-container">
      <div id="court-wrapper">
        <canvas id="court-canvas"></canvas>
        <canvas id="draw-canvas"></canvas>

        <!-- ä¸»å®¢å ´æ¨™ç±¤ -->
        <div id="side-labels">
          <div class="side-lbl" id="lbl-left"  style="color:#3498db">ğŸ”µæˆ‘æ–¹</div>
          <div class="side-lbl" id="lbl-right" style="color:#e74c3c">ğŸ”´å°æ–¹</div>
        </div>

        <!-- ç™¼çƒæ—— -->
        <div id="serve-flag">ğŸ¸</div>

        <!-- æµ®å‹• HUDï¼ˆå ´åœ°å·¦ä¸‹è§’ï¼‰ -->
        <div id="hud">
          <!-- çƒå“¡é¸æ“‡ -->
          <div style="display:flex;align-items:center;gap:5px;">
            <span class="hud-sep">çƒå“¡</span>
            <div id="hud-players"></div>
          </div>
          <!-- çƒé¸æ“‡ -->
          <div style="display:flex;align-items:center;gap:5px;">
            <span class="hud-sep">çƒ</span>
            <div id="hud-balls"></div>
          </div>
          <!-- æ“ä½œæŒ‰éˆ• -->
          <div id="hud-actions">
            <button class="hud-btn" onclick="undo()" title="å¾©åŸ Ctrl+Z">â†© å¾©åŸ</button>
            <button class="hud-btn" onclick="clearActive()" title="æ¸…é™¤é¸å–">ğŸ—‘ æ¸…é¸å–</button>
            <button class="hud-btn red" onclick="resetAll()" title="å…¨éƒ¨é‡ç½® [R]">â™» é‡ç½®</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¯¦é«”è³‡æ–™
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYERS = [
  {id:0, name:'çƒå“¡ 1', color:'#E74C3C', visible:true, pos:null, strokes:[]},
  {id:1, name:'çƒå“¡ 2', color:'#3498DB', visible:true, pos:null, strokes:[]},
  {id:2, name:'çƒå“¡ 3', color:'#2ECC71', visible:true, pos:null, strokes:[]},
  {id:3, name:'çƒå“¡ 4', color:'#F39C12', visible:true, pos:null, strokes:[]},
];

const BALLS = [
  {id:0, name:'çƒ 1', color:'#F5F5F5', borderColor:'#AAAAAA', visible:true, pos:null, strokes:[]},
  {id:1, name:'çƒ 2', color:'#F1C40F', borderColor:'#D4AC0D',  visible:true, pos:null, strokes:[]},
  {id:2, name:'çƒ 3', color:'#E67E22', borderColor:'#CA6F1E',  visible:true, pos:null, strokes:[]},
  {id:3, name:'çƒ 4', color:'#1ABC9C', borderColor:'#17A589',  visible:true, pos:null, strokes:[]},
];

const state = {
  active:0, activeType:'ball',
  mode:'draw', courtType:'doubles',
  homeSide:'left', serveSide:'none',
  lineWidth:3, lineDash:'solid',
  drawing:false, curStroke:[],
  pendingPlace:false,  // ç­‰å¾…é»æ“Šæ”¾ç½®æ£‹å­
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨åŸŸ Undo Stack
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAX_UNDO = 60;
const undoStack = [];

function pushUndo(action) {
  undoStack.push(action);
  if (undoStack.length > MAX_UNDO) undoStack.shift();
}

function undo() {
  if (undoStack.length === 0) return;
  const a = undoStack.pop();
  const arr = a.who === 'player' ? PLAYERS : BALLS;
  const entity = arr[a.id];
  switch (a.type) {
    case 'stroke':
      entity.strokes.pop();
      break;
    case 'place':
      entity.pos = a.from;
      break;
    case 'erase-marker':
      entity.pos = a.pos;
      break;
    case 'erase-stroke':
      entity.strokes.splice(a.idx, 0, a.stroke);
      break;
  }
  redraw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Icon åœ–ç‰‡é è¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const playerImg = new Image();
playerImg.src = '/images/badminton-player-icon.png';
const shuttleImg = new Image();
shuttleImg.src = '/images/badminton-shuttle-icon.png';
let iconsReady = false;
let loadedCount = 0;
function onIconLoad() { loadedCount++; if (loadedCount >= 2) { iconsReady = true; redraw(); } }
playerImg.onload = onIconLoad;
shuttleImg.onload = onIconLoad;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Canvas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const courtC    = document.getElementById('court-canvas');
const drawC     = document.getElementById('draw-canvas');
const cc        = courtC.getContext('2d');
const dc        = drawC.getContext('2d');
const wrapper   = document.getElementById('court-wrapper');
const container = document.getElementById('court-container');

// ç¾½çƒå ´åœ‹éš›æ¨™æº– (å…¬å°º)
const COURT_W = 13.4;
const COURT_H = 6.1;
const MARGIN  = 18;

let CW=0, CH=0, SC=1, OFFSET_X=0, OFFSET_Y=0;

function computeScale() {
  const scW = (CW - MARGIN*2) / COURT_W;
  const scH = (CH - MARGIN*2) / COURT_H;
  SC = Math.min(scW, scH);
  OFFSET_X = (CW - COURT_W * SC) / 2;
  OFFSET_Y = (CH - COURT_H * SC) / 2;
}

function resize() {
  const cr   = container.getBoundingClientRect();
  const availW = cr.width  - 12;
  const availH = cr.height - 12;
  const aspect = COURT_W / COURT_H;
  let w, h;
  if (availW / availH > aspect) { h=availH; w=h*aspect; }
  else                           { w=availW; h=w/aspect; }
  CW = Math.floor(w); CH = Math.floor(h);
  [courtC, drawC].forEach(c=>{ c.width=CW; c.height=CH; });
  wrapper.style.cssText = `width:${CW}px;height:${CH}px;`;
  computeScale();
  redraw();
}

const cx = m => OFFSET_X + m * SC;
const cy = m => OFFSET_Y + m * SC;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç¹ªè£½å ´åœ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawCourt() {
  const c = cc;
  c.clearRect(0,0,CW,CH);

  // ç™½åº•
  c.fillStyle = '#ffffff';
  c.fillRect(0,0,CW,CH);

  // æˆ‘æ–¹/å°æ–¹åº•è‰²
  const homeLeft  = state.homeSide === 'left';
  const homeColor = 'rgba(52,152,219,0.06)';
  const awayColor = 'rgba(231,76,60,0.06)';
  c.fillStyle = homeLeft ? homeColor : awayColor;
  c.fillRect(cx(0), cy(0), cx(COURT_W/2)-cx(0), cy(COURT_H)-cy(0));
  c.fillStyle = homeLeft ? awayColor : homeColor;
  c.fillRect(cx(COURT_W/2), cy(0), cx(COURT_W)-cx(COURT_W/2), cy(COURT_H)-cy(0));

  // å–®æ‰“å€å¤–å´é™°å½±
  if (state.courtType === 'singles') {
    c.fillStyle = 'rgba(0,0,0,0.07)';
    c.fillRect(cx(0), cy(0),            cx(COURT_W)-cx(0), cy(0.46)-cy(0));
    c.fillRect(cx(0), cy(COURT_H-0.46), cx(COURT_W)-cx(0), cy(COURT_H)-cy(COURT_H-0.46));
  }

  // â”€â”€ Mido Learning æµ®æ°´å° â”€â”€
  const wCX = cx(COURT_W/2);
  const wCY = cy(COURT_H/2);
  c.save();
  c.globalAlpha = 0.07;
  const wFontSize = Math.round(Math.min(COURT_W, COURT_H) * SC * 0.13);
  c.font = `bold italic ${wFontSize}px 'Helvetica Neue', Arial, sans-serif`;
  c.fillStyle = '#1a4080';
  c.textAlign = 'center';
  c.textBaseline = 'middle';
  c.fillText('Mido Learning', wCX, wCY - wFontSize * 0.6);
  const wFontSize2 = Math.round(wFontSize * 0.45);
  c.font = `${wFontSize2}px Arial, sans-serif`;
  c.fillText('ç¾½çƒæˆ°è¡“ç‰ˆ', wCX, wCY + wFontSize2 * 0.3);
  c.restore();

  // å ´åœ°ç·š
  c.strokeStyle = '#1a1a8e';
  c.lineWidth   = 2;
  c.setLineDash([]);
  c.lineCap = 'square';

  // å¤–æ¡†ï¼ˆé›™æ‰“é‚Šç•Œï¼‰â€” å®Œæ•´çŸ©å½¢
  c.strokeRect(cx(0), cy(0), cx(COURT_W)-cx(0), cy(COURT_H)-cy(0));

  // é•·ç™¼çƒç·šï¼ˆé›™æ‰“ï¼Œè·åº•ç·š 0.76mï¼‰
  line(c, cx(0.76),         cy(0), cx(0.76),         cy(COURT_H));
  line(c, cx(COURT_W-0.76), cy(0), cx(COURT_W-0.76), cy(COURT_H));

  // çŸ­ç™¼çƒç·šï¼ˆè·çƒç¶² 1.98mï¼‰
  const ssl = COURT_W/2 - 1.98; // = 4.72m from left
  line(c, cx(ssl),          cy(0), cx(ssl),          cy(COURT_H));
  line(c, cx(COURT_W-ssl),  cy(0), cx(COURT_W-ssl),  cy(COURT_H));

  // å–®æ‰“é‚Šç·šï¼ˆèˆ‡å¤–æ¡†é½Šå¹³ï¼Œæ©«å‘ç·šï¼‰
  line(c, cx(0), cy(0.46),          cx(COURT_W), cy(0.46));
  line(c, cx(0), cy(COURT_H-0.46),  cx(COURT_W), cy(COURT_H-0.46));

  // ä¸­ç·šï¼ˆå¾Œå ´æœå‹™å€åˆ†ç•Œï¼‰
  line(c, cx(0.76),        cy(COURT_H/2), cx(ssl),          cy(COURT_H/2));
  line(c, cx(COURT_W-ssl), cy(COURT_H/2), cx(COURT_W-0.76), cy(COURT_H/2));

  // çƒç¶²ï¼ˆä¸­ç·šåŠ ç²—ï¼‰
  c.strokeStyle = '#555';
  c.lineWidth   = 3;
  line(c, cx(COURT_W/2), cy(0), cx(COURT_W/2), cy(COURT_H));

  // çƒæŸ±
  c.fillStyle = '#333';
  dot(c, cx(COURT_W/2), cy(0),       5);
  dot(c, cx(COURT_W/2), cy(COURT_H), 5);

  drawServe(c);
}

function line(c,x1,y1,x2,y2){c.beginPath();c.moveTo(x1,y1);c.lineTo(x2,y2);c.stroke();}
function dot(c,x,y,r){c.beginPath();c.arc(x,y,r,0,Math.PI*2);c.fill();}

function drawServe(c) {
  const flag = document.getElementById('serve-flag');
  if (state.serveSide === 'none') { flag.style.display='none'; return; }
  const isLeft = state.serveSide === 'left';
  const px = isLeft ? cx(1.5) : cx(COURT_W-1.5);
  const py = cy(COURT_H/2);
  flag.style.display = 'block';
  flag.style.left = (px-12)+'px';
  flag.style.top  = (py-12)+'px';
  flag.style.transform = 'none';
  c.fillStyle = 'rgba(241,196,15,0.18)';
  c.beginPath(); c.arc(px, py, 20, 0, Math.PI*2); c.fill();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// èµ°ç·š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawStrokes(ctx) {
  PLAYERS.forEach(p => {
    if (!p.visible) return;
    p.strokes.forEach(s => paintStroke(ctx, s.pts, p.color, s.w, s.dash));
  });
  BALLS.forEach(b => {
    if (!b.visible) return;
    b.strokes.forEach(s => paintStroke(ctx, s.pts, b.color, s.w, s.dash));
  });
}

function paintStroke(ctx, pts, color, w, dash) {
  if (pts.length < 2) return;
  const dashPat = dash==='dashed'?[w*3,w*2]:[];
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';

  // æ·±è‰²è¼ªå»“è®“ç·šåœ¨ä»»ä½•åº•è‰²éƒ½æ¸…æ™°å¯è¦‹
  ctx.strokeStyle = 'rgba(0,0,0,0.55)'; ctx.lineWidth = w + 3;
  ctx.setLineDash(dashPat);
  ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
  for (let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y);
  ctx.stroke();

  // æœ¬é«”é¡è‰²
  ctx.strokeStyle = color; ctx.lineWidth = w;
  ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
  for (let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y);
  ctx.stroke(); ctx.setLineDash([]);
  if (dash==='arrow'&&pts.length>=2) {
    const a=pts[pts.length-2], b=pts[pts.length-1];
    arrow(ctx,a.x,a.y,b.x,b.y,color,w);
  }
}

function arrow(ctx,fx,fy,tx,ty,color,w) {
  const len=Math.max(10,w*4), ang=Math.atan2(ty-fy,tx-fx);
  ctx.fillStyle=color; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(tx,ty);
  ctx.lineTo(tx-len*Math.cos(ang-Math.PI/6), ty-len*Math.sin(ang-Math.PI/6));
  ctx.lineTo(tx-len*Math.cos(ang+Math.PI/6), ty-len*Math.sin(ang+Math.PI/6));
  ctx.closePath(); ctx.fill();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// çƒå“¡ & çƒ æ¨™è¨˜ç¹ªè£½
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MR = 14; // çƒå“¡åŠå¾‘
const BR = 11; // çƒåŠå¾‘

function drawMarkers(ctx) {
  PLAYERS.forEach(p => {
    if (!p.visible||!p.pos) return;
    paintEntityMarker(ctx, p.pos.x, p.pos.y, p.color, p.name, p.id===state.active&&state.activeType==='player', 'player', p.id);
  });
  BALLS.forEach(b => {
    if (!b.visible||!b.pos) return;
    paintEntityMarker(ctx, b.pos.x, b.pos.y, b.color, b.name, b.id===state.active&&state.activeType==='ball', 'ball', b.id);
  });
}

function paintEntityMarker(ctx, x, y, color, name, isActive, type, id) {
  const r = type === 'ball' ? BR : MR;
  const img = type === 'ball' ? shuttleImg : playerImg;

  ctx.save();
  ctx.shadowColor='rgba(0,0,0,0.45)'; ctx.shadowBlur=6;
  ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;

  // åº•è‰²åœ“
  ctx.fillStyle = color;
  ctx.strokeStyle = isActive ? '#fff' : 'rgba(255,255,255,0.4)';
  ctx.lineWidth   = isActive ? 3 : 1.5;
  ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2);
  ctx.fill(); ctx.stroke();

  ctx.shadowColor='transparent'; ctx.shadowBlur=0;
  ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;

  // è‹¥åœ–ç¤ºå·²è¼‰å…¥ï¼Œç¹ªè£½åœ–ç¤º
  if (iconsReady && img.complete && img.naturalWidth > 0) {
    const d = r * 1.6;
    ctx.drawImage(img, x - d/2, y - d/2, d, d);
  } else {
    // Fallback: æ–‡å­—é¦–å­—
    ctx.fillStyle = type === 'ball' ? '#333' : '#fff';
    ctx.font = `bold ${Math.round(r*0.85)}px sans-serif`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(name.charAt(0).toUpperCase(), x, y);
  }

  // é¸ä¸­é«˜äº®å¤–åœˆ
  if (isActive) {
    ctx.strokeStyle = 'rgba(255,255,255,0.6)';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.arc(x, y, r+5, 0, Math.PI*2);
    ctx.stroke(); ctx.setLineDash([]);
  }

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨éƒ¨é‡ç¹ª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function redraw() {
  drawCourt();
  dc.clearRect(0,0,CW,CH);
  drawStrokes(dc);
  const ae = getActiveEntity();
  if (state.drawing && state.curStroke.length>1)
    paintStroke(dc, state.curStroke, ae.color, state.lineWidth, state.lineDash);
  drawMarkers(dc);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¼”åŠ©ï¼šå–å¾—ç•¶å‰é¸ä¸­å¯¦é«”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getActiveEntity() {
  return state.activeType === 'player' ? PLAYERS[state.active] : BALLS[state.active];
}
function getEntityArray() {
  return state.activeType === 'player' ? PLAYERS : BALLS;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äº‹ä»¶åº§æ¨™
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pos(e) {
  const r=drawC.getBoundingClientRect();
  const sx=drawC.width/r.width, sy=drawC.height/r.height;
  let ex,ey;
  if (e.touches?.length)           {ex=e.touches[0].clientX;       ey=e.touches[0].clientY;}
  else if (e.changedTouches?.length){ex=e.changedTouches[0].clientX;ey=e.changedTouches[0].clientY;}
  else                              {ex=e.clientX; ey=e.clientY;}
  return {x:(ex-r.left)*sx, y:(ey-r.top)*sy};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ‹–æ›³ï¼šåŒæ™‚è™•ç†çƒå“¡èˆ‡çƒ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// drag çµæ§‹: {who:'player'|'ball', id:N}
let drag=null, dragOff={x:0,y:0};

function hitMarker(p) {
  // çƒå“¡ï¼ˆå¾Œæ¸²æŸ“ = å„ªå…ˆå‘½ä¸­ï¼‰
  for (let i=PLAYERS.length-1;i>=0;i--) {
    const pl=PLAYERS[i];
    if (!pl.visible||!pl.pos) continue;
    if (Math.hypot(p.x-pl.pos.x, p.y-pl.pos.y) <= MR+5) return {who:'player',id:i};
  }
  // çƒ
  for (let i=BALLS.length-1;i>=0;i--) {
    const bl=BALLS[i];
    if (!bl.visible||!bl.pos) continue;
    if (Math.hypot(p.x-bl.pos.x, p.y-bl.pos.y) <= BR+5) return {who:'ball',id:i};
  }
  return null;
}

function entityAt(hit) {
  return hit.who === 'player' ? PLAYERS[hit.id] : BALLS[hit.id];
}

function onDown(e) {
  e.preventDefault();
  const p=pos(e);
  if (state.mode==='place') {
    const h=hitMarker(p);
    if (h) {
      drag=h; dragOff={x:p.x-entityAt(h).pos.x, y:p.y-entityAt(h).pos.y};
      selectEntity(h.who, h.id);
    } else {
      const ae=getActiveEntity();
      const oldPos=ae.pos ? {...ae.pos} : null;
      ae.pos={x:p.x,y:p.y};
      pushUndo({type:'place',who:state.activeType,id:state.active,from:oldPos});
      redraw();
    }
    return;
  }
  if (state.mode==='erase') {
    const h=hitMarker(p);
    if (h) {
      const ent=entityAt(h);
      pushUndo({type:'erase-marker',who:h.who,id:h.id,pos:{...ent.pos}});
      ent.pos=null;
    } else {
      eraseNear(p);
    }
    redraw(); return;
  }
  // draw mode
  const h=hitMarker(p);
  if (h){drag=h;dragOff={x:p.x-entityAt(h).pos.x,y:p.y-entityAt(h).pos.y};selectEntity(h.who,h.id);return;}
  // ä¸€æ¬¡æ€§æ”¾ç½®æ¨¡å¼ï¼šæ£‹å­é‚„æ²’æ“ºä¸Šå ´ï¼Œé»å“ªå°±æ”¾å“ªï¼Œæ”¾å®Œè‡ªå‹•å›ç•«ç·š
  if (state.pendingPlace) {
    const ae=getActiveEntity();
    pushUndo({type:'place',who:state.activeType,id:state.active,from:null});
    ae.pos={x:p.x,y:p.y};
    state.pendingPlace=false;
    updateCursor();
    renderHUD();
    redraw();
    return;
  }
  state.drawing=true; state.curStroke=[{x:p.x,y:p.y}];
}

function onMove(e) {
  e.preventDefault();
  const p=pos(e);
  if (drag){
    const ent=entityAt(drag);
    ent.pos={x:p.x-dragOff.x, y:p.y-dragOff.y};
    redraw(); return;
  }
  if (state.drawing){state.curStroke.push({x:p.x,y:p.y});redraw();}
}

function onUp(e) {
  e.preventDefault();
  if (drag) {
    const ent=entityAt(drag);
    // æ‰¾æ‹–æ›³å‰çš„ä½ç½®ï¼šæ­¤æ™‚å·²ç§»å‹•ï¼Œå–æ¶ˆ pushï¼ˆä¸è¨˜éŒ„åˆå§‹ fromï¼Œæ‹–æ›³çµæŸå¾Œè¨˜éŒ„ï¼‰
    // è¨˜éŒ„ç‚º place å‹•ä½œï¼ˆfrom = undefinedï¼Œundo æ™‚ç½® nullï¼‰
    pushUndo({type:'place',who:drag.who,id:drag.id,from:null});
    drag=null; redraw(); return;
  }
  if (state.drawing) {
    state.drawing=false;
    if (state.curStroke.length>=2) {
      const ae=getActiveEntity();
      const stroke={pts:[...state.curStroke],w:state.lineWidth,dash:state.lineDash};
      ae.strokes.push(stroke);
      pushUndo({type:'stroke',who:state.activeType,id:state.active});
    }
    state.curStroke=[];
    redraw();
  }
}

function eraseNear(p) {
  const checkArr = (arr, who) => {
    for (const ent of arr) {
      for (let i=ent.strokes.length-1;i>=0;i--) {
        for (const pt of ent.strokes[i].pts) {
          if (Math.hypot(pt.x-p.x,pt.y-p.y)<14) {
            const stroke=ent.strokes.splice(i,1)[0];
            pushUndo({type:'erase-stroke',who,id:ent.id,idx:i,stroke});
            return true;
          }
        }
      }
    }
    return false;
  };
  if (!checkArr(PLAYERS,'player')) checkArr(BALLS,'ball');
}

drawC.addEventListener('mousedown', onDown);
drawC.addEventListener('mousemove', onMove);
drawC.addEventListener('mouseup',   onUp);
drawC.addEventListener('mouseleave',onUp);
drawC.addEventListener('touchstart', onDown,{passive:false});
drawC.addEventListener('touchmove',  onMove,{passive:false});
drawC.addEventListener('touchend',   onUp,  {passive:false});
drawC.addEventListener('touchcancel',onUp,  {passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ§åˆ¶å‡½å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(m) {
  state.mode=m;
  ['draw','place','erase'].forEach(x=>document.getElementById('btn-'+x).classList.toggle('on',x===m));
  updateCursor();
}

function setCourtType(t) {
  state.courtType=t;
  document.getElementById('btn-doubles').classList.toggle('on',t==='doubles');
  document.getElementById('btn-singles').classList.toggle('on',t==='singles');
  redraw();
}

function setServe(s) {
  state.serveSide=s;
  ['sl','sr','sn'].forEach(x=>document.getElementById('btn-'+x).classList.remove('on'));
  if (s==='left')  document.getElementById('btn-sl').classList.add('on');
  if (s==='right') document.getElementById('btn-sr').classList.add('on');
  if (s==='none')  document.getElementById('btn-sn').classList.add('on');
  redraw();
}

function setHome(side) {
  state.homeSide=side;
  document.getElementById('btn-hl').classList.toggle('on',side==='left');
  document.getElementById('btn-hr').classList.toggle('on',side==='right');
  const ll=document.getElementById('lbl-left'), lr=document.getElementById('lbl-right');
  if (side==='left'){
    ll.textContent='ğŸ”µæˆ‘æ–¹';ll.style.color='#3498db';
    lr.textContent='ğŸ”´å°æ–¹';lr.style.color='#e74c3c';
  } else {
    ll.textContent='ğŸ”´å°æ–¹';ll.style.color='#e74c3c';
    lr.textContent='ğŸ”µæˆ‘æ–¹';lr.style.color='#3498db';
  }
  redraw();
}

function setDash(d) {
  state.lineDash=d;
  ['solid','dashed','arrow'].forEach(x=>document.getElementById('btn-'+x).classList.toggle('on',x===d));
}

function clearActive() {
  const ae=getActiveEntity();
  ae.strokes=[]; ae.pos=null;
  redraw();
}

function resetAll() {
  if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èµ°ç·šèˆ‡ç«™ä½ï¼Ÿ')) return;
  PLAYERS.forEach(p=>{p.strokes=[];p.pos=null;});
  BALLS.forEach(b=>{b.strokes=[];b.pos=null;});
  undoStack.length=0;
  setServe('none');
  redraw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHUD() {
  renderHUDRow('hud-players', PLAYERS, 'player');
  renderHUDRow('hud-balls',   BALLS,   'ball');
}

function renderHUDRow(elId, arr, type) {
  const el=document.getElementById(elId);
  el.innerHTML='';
  arr.forEach((ent, i) => {
    const b=document.createElement('button');
    const isActive = (i===state.active && state.activeType===type);
    const isPending = isActive && state.pendingPlace;
    b.className='hud-entity'+(type==='ball'?' hud-ball':'')+(isPending?' pending':isActive?' sel':'');
    b.style.setProperty('--c', ent.color);
    if (type==='ball') {
      b.style.border = `2.5px solid ${isActive ? '#fff' : ent.borderColor || 'rgba(255,255,255,0.25)'}`;
    }
    b.title = ent.name + ' ['+(i+1)+']';
    b.innerHTML = `<span class="eid">${i+1}</span>`;
    b.onclick = () => selectEntity(type, i);
    el.appendChild(b);
  });
}

function selectEntity(type, i) {
  state.activeType = type;
  state.active = i;
  const ent = type === 'player' ? PLAYERS[i] : BALLS[i];
  // è‹¥æ£‹å­å°šæœªæ”¾ç½®ï¼Œè‡ªå‹•ç­‰å¾…ä¸€æ¬¡æ€§æ”¾ç½®
  state.pendingPlace = !ent.pos;
  updateCursor();
  renderHUD();
  redraw();
}

function updateCursor() {
  if (state.pendingPlace) {
    drawC.style.cursor = 'copy';  // æš—ç¤ºã€Œé»æ“Šæ”¾ç½®ã€
  } else if (state.mode==='draw') {
    drawC.style.cursor = 'crosshair';
  } else if (state.mode==='erase') {
    drawC.style.cursor = 'cell';
  } else {
    drawC.style.cursor = 'move';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// éµç›¤å¿«æ·éµ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e=>{
  if (e.target.tagName==='INPUT') return;
  const k=e.key.toLowerCase();
  if ((e.ctrlKey||e.metaKey)&&k==='z'){e.preventDefault();undo();return;}
  if (e.key==='Escape'&&state.pendingPlace){state.pendingPlace=false;updateCursor();renderHUD();return;}
  switch(k){
    case 'q': setMode('draw');  break;
    case 'w': setMode('place'); break;
    case 'e': setMode('erase'); break;
    case 'a': setServe('left');  break;
    case 'd': setServe('right'); break;
    case 'r': if(!e.ctrlKey) resetAll(); break;
    case 's': setCourtType(state.courtType==='doubles'?'singles':'doubles'); break;
    case '1': selectEntity('player',0); break;
    case '2': selectEntity('player',1); break;
    case '3': selectEntity('player',2); break;
    case '4': selectEntity('player',3); break;
    case '5': selectEntity('ball',0); break;
    case '6': selectEntity('ball',1); break;
    case '7': selectEntity('ball',2); break;
    case '8': selectEntity('ball',3); break;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Resize
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let resizeTimer;
window.addEventListener('resize',()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(resize,80);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderHUD();
setServe('none');
resize();
</script>
</body>
</html>
